local precacheModelsTBL = {
  "models/smalls_civilians/pack1/hoodie_male_01_pm.mdl",
  "models/smalls_civilians/pack1/hoodie_male_02_pm.mdl",
  "models/smalls_civilians/pack1/hoodie_male_03_pm.mdl",
  "models/smalls_civilians/pack1/hoodie_male_04_pm.mdl",
  "models/smalls_civilians/pack1/hoodie_male_05_pm.mdl",
  "models/smalls_civilians/pack1/hoodie_male_07_pm.mdl",
  "models/smalls_civilians/pack1/hoodie_male_09_pm.mdl",
  "models/smalls_civilians/pack1/puffer_male_01_pm.mdl",
  "models/smalls_civilians/pack1/puffer_male_02_pm.mdl",
  "models/smalls_civilians/pack1/puffer_male_03_pm.mdl",
  "models/smalls_civilians/pack1/puffer_male_04_pm.mdl",
  "models/smalls_civilians/pack1/puffer_male_05_pm.mdl",
  "models/smalls_civilians/pack1/puffer_male_07_pm.mdl",
  "models/smalls_civilians/pack1/puffer_male_09_pm.mdl",
  "models/smalls_civilians/pack1/zipper_female_01_pm.mdl",
  "models/smalls_civilians/pack1/zipper_female_02_pm.mdl",
  "models/smalls_civilians/pack1/zipper_female_03_pm.mdl",
  "models/smalls_civilians/pack1/zipper_female_04_pm.mdl",
  "models/smalls_civilians/pack1/zipper_female_06_pm.mdl",
  "models/smalls_civilians/pack1/zipper_female_07_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiepulloverjeans/female_01_hoodiepulloverjeans_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiepulloverjeans/female_02_hoodiepulloverjeans_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiepulloverjeans/female_03_hoodiepulloverjeans_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiepulloverjeans/female_04_hoodiepulloverjeans_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiepulloverjeans/female_06_hoodiepulloverjeans_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiepulloverjeans/female_07_hoodiepulloverjeans_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiepulloversweats/female_01_hoodiepulloversweats_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiepulloversweats/female_02_hoodiepulloversweats_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiepulloversweats/female_03_hoodiepulloversweats_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiepulloversweats/female_04_hoodiepulloversweats_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiepulloversweats/female_06_hoodiepulloversweats_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiepulloversweats/female_07_hoodiepulloversweats_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiezippedjeans/female_01_hoodiezippedjeans_pm.mdl",    
  "models/smalls_civilians/pack2/female/hoodiezippedjeans/female_02_hoodiezippedjeans_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiezippedjeans/female_03_hoodiezippedjeans_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiezippedjeans/female_04_hoodiezippedjeans_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiezippedjeans/female_06_hoodiezippedjeans_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiezippedjeans/female_07_hoodiezippedjeans_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiezippedsweats/female_01_hoodiezippedsweats_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiezippedsweats/female_02_hoodiezippedsweats_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiezippedsweats/female_03_hoodiezippedsweats_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiezippedsweats/female_04_hoodiezippedsweats_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiezippedsweats/female_06_hoodiezippedsweats_pm.mdl",
  "models/smalls_civilians/pack2/female/hoodiezippedsweats/female_07_hoodiezippedsweats_pm.mdl",
  "models/smalls_civilians/pack2/female/parkajeans/female_01_parkajeans_pm.mdl",
  "models/smalls_civilians/pack2/female/parkajeans/female_02_parkajeans_pm.mdl",
  "models/smalls_civilians/pack2/female/parkajeans/female_03_parkajeans_pm.mdl",
  "models/smalls_civilians/pack2/female/parkajeans/female_04_parkajeans_pm.mdl",
  "models/smalls_civilians/pack2/female/parkajeans/female_06_parkajeans_pm.mdl",
  "models/smalls_civilians/pack2/female/parkajeans/female_07_parkajeans_pm.mdl",
  "models/smalls_civilians/pack2/female/parkasweats/female_01_parkasweats_pm.mdl",
  "models/smalls_civilians/pack2/female/parkasweats/female_02_parkasweats_pm.mdl",
  "models/smalls_civilians/pack2/female/parkasweats/female_03_parkasweats_pm.mdl",
  "models/smalls_civilians/pack2/female/parkasweats/female_04_parkasweats_pm.mdl",
  "models/smalls_civilians/pack2/female/parkasweats/female_06_parkasweats_pm.mdl",
  "models/smalls_civilians/pack2/female/parkasweats/female_07_parkasweats_pm.mdl",
  "models/smalls_civilians/pack2/male/baseballtee/male_01_baseballtee_pm.mdl",
  "models/smalls_civilians/pack2/male/baseballtee/male_02_baseballtee_pm.mdl",
  "models/smalls_civilians/pack2/male/baseballtee/male_03_baseballtee_pm.mdl",
  "models/smalls_civilians/pack2/male/baseballtee/male_04_baseballtee_pm.mdl",
  "models/smalls_civilians/pack2/male/baseballtee/male_06_baseballtee_pm.mdl",
  "models/smalls_civilians/pack2/male/baseballtee/male_07_baseballtee_pm.mdl",
  "models/smalls_civilians/pack2/male/flannel/male_01_flannel_pm.mdl",
  "models/smalls_civilians/pack2/male/flannel/male_02_flannel_pm.mdl",
  "models/smalls_civilians/pack2/male/flannel/male_03_flannel_pm.mdl",
  "models/smalls_civilians/pack2/male/flannel/male_04_flannel_pm.mdl",
  "models/smalls_civilians/pack2/male/flannel/male_05_flannel_pm.mdl",
  "models/smalls_civilians/pack2/male/flannel/male_06_flannel_pm.mdl",
  "models/smalls_civilians/pack2/male/flannel/male_07_flannel_pm.mdl",
  "models/smalls_civilians/pack2/male/leatherjacket/male_01_leather_jacket_pm.mdl",
  "models/smalls_civilians/pack2/male/leatherjacket/male_02_leather_jacket_pm.mdl",
  "models/smalls_civilians/pack2/male/leatherjacket/male_03_leather_jacket_pm.mdl",
  "models/smalls_civilians/pack2/male/leatherjacket/male_04_leather_jacket_pm.mdl",
  "models/smalls_civilians/pack2/male/leatherjacket/male_05_leather_jacket_pm.mdl",
  "models/smalls_civilians/pack2/male/leatherjacket/male_06_leather_jacket_pm.mdl",
  "models/smalls_civilians/pack2/male/leatherjacket/male_07_leather_jacket_pm.mdl",
  "models/smalls_civilians/pack2/male/leatherjacket/male_08_leather_jacket_pm.mdl",
  "models/smalls_civilians/pack2/male/leatherjacket/male_09_leather_jacket_pm.mdl",
  "models/sentry/sentryeightmob/mafia/sentrybusi3male2pm.mdl",
}
local PANEL_WIDTH = 624 / 3
local PANEL_HEIGHT = 439 / 3
local CacheFrame
local currentModel = 0

local function PaintCacheFrame(self, w, h, progress)
    draw.RoundedBox(0, 0, 0, w, h, DarkRP.Library.AlphaColor(DarkRP.Config.Colors["Main"], 200))
    DarkRP.Library.DrawMaterialSwing(DarkRP.Library.FetchCDN("prisel_main/prisel_logo_bleu"), w / 2, h / 2 - h * 0.15, PANEL_WIDTH - w / w, PANEL_HEIGHT - h / h, 10, 2)
    draw.SimpleText("Précache des modèles en cours", DarkRP.Library.Font(12, 0, "Montserrat Bold"), w / 2, h / 2, color_white, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
    draw.RoundedBox(DarkRP.Config.RoundedBoxValue, w / 2 - w * 0.2, h / 2 + h * 0.05, w * 0.4, h * 0.04, DarkRP.Library.AlphaColor(color_white, 100))
    draw.RoundedBox(DarkRP.Config.RoundedBoxValue, w / 2 - w * 0.2, h / 2 + h * 0.05, w * 0.4 * math.Clamp(progress, 0, 1), h * 0.04, DarkRP.Library.AlphaColor(DarkRP.Config.Colors["Blue"], 180))
    draw.SimpleText(string.format("%.f%%", progress * 100), DarkRP.Library.Font(9, 0, "Montserrat Bold"), w / 2, h / 2 + h * 0.068, color_white, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
end

local function precacheModels()
    if IsValid(CacheFrame) then
        CacheFrame:Remove()
        return
    end

    CacheFrame = vgui.Create("DPanel")
    CacheFrame:SetSize(DarkRP.ScrW, DarkRP.ScrH)
    CacheFrame:SetAlpha(0)
    CacheFrame:MakePopup()
    CacheFrame:AlphaTo(255, 0.3, 0)
    CacheFrame:Center()
    CacheFrame.Paint = function(self, w, h)
        local progressLerp = Lerp(FrameTime() * 2.5, currentModel / #precacheModelsTBL, 1)
        PaintCacheFrame(self, w, h, progressLerp)
    end

    timer.Create("Prisel_Cache_Model", 0.1, 0, function()
        if currentModel > #precacheModelsTBL then
            timer.Remove("Prisel_Cache_Model")
            CacheFrame:Remove()
            return
        end

        if not IsValid(CacheFrame) then
            timer.Remove("Prisel_Cache_Model")
            CacheFrame:Remove()
            gui.EnableScreenClicker(false)
            return
        end

        currentModel = currentModel + 1
        if precacheModelsTBL[currentModel] ~= nil then
            util.PrecacheModel(precacheModelsTBL[currentModel])
            print(string.format("Précache du modèle %s terminé !", precacheModelsTBL[currentModel]))
        end
    end)
end

concommand.Add("prisel_precache", precacheModels)

hook.Add("DarkRPFinishedLoading", "PriselV3:PrecacheMenu", function()
    precacheModels()
end)
